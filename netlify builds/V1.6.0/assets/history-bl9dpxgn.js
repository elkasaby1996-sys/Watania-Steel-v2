var Ne=Object.defineProperty,ye=Object.defineProperties;var ve=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var be=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var se=(i,a,o)=>a in i?Ne(i,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[a]=o,te=(i,a)=>{for(var o in a||(a={}))be.call(a,o)&&se(i,o,a[o]);if(ee)for(var o of ee(a))Se.call(a,o)&&se(i,o,a[o]);return i},re=(i,a)=>ye(i,ve(a));var D=(i,a,o)=>new Promise((M,u)=>{var C=j=>{try{S(o.next(j))}catch(y){u(y)}},R=j=>{try{S(o.throw(j))}catch(y){u(y)}},S=j=>j.done?M(j.value):Promise.resolve(j.value).then(C,R);S((o=o.apply(i,a)).next())});import{u as ae,a as De,b as we,f as _e,g as Ce,r as h,j as e,B as b,C as w,I as Oe,R as ke,d as g,i as ne,h as A}from"./index-yWCqtgWP.js";import{T as ie,a as le,b as E,c,d as oe,e as d}from"./table-CBV96gol.js";import{T as Te,a as Be,b as ze,c as Ae}from"./tabs-B8H4Xp9H.js";import{E as ce,O as Ee}from"./OrderDetailsDialog-CaCQ7Qdy.js";import{a as _,R as de}from"./RoleBasedComponent-Bw7TjrVH.js";import{A as He}from"./arrow-left-NIcPJLgR.js";import{S as L}from"./search-BMyTM2pA.js";import{C as H}from"./circle-check-big-DnuHpE59.js";import{S as me}from"./square-pen-Cv1NC3RC.js";import{C as Me}from"./calendar-SSTEyxcS.js";import"./dialog-DJKQQ3Aj.js";import"./select-CrCA7bkJ.js";import"./index-UTeR_lmU.js";import"./calculator-EU8dGyxE.js";import"./weight-C_CrPdNh.js";import"./phone-BxJRnI92.js";function es(){const i=ae(),{user:a}=De(),{toast:o}=we(),M=_e();Ce();const[u,C]=h.useState(""),[R,S]=h.useState(null),[j,y]=h.useState(!1),[xe,O]=h.useState(!0),[k,T]=h.useState([]),[v,B]=h.useState(!1),[W,U]=h.useState(""),[f,I]=h.useState(!1);h.useEffect(()=>{D(null,null,function*(){O(!0),i!=null&&i.loadHistoryOrders&&(yield i.loadHistoryOrders()),O(!1)})},[]);const ue=()=>{i!=null&&i.loadHistoryOrders&&i.loadHistoryOrders(),C(""),T([]),B(!1),I(!1)},$=()=>D(null,null,function*(){if(!u.trim()){T([]),B(!1);return}O(!0);try{const s=yield i.searchHistoryOrders(u);T(s),B(!0)}catch(s){console.error("Search failed:",s),o({title:"Search Failed",description:"Could not search orders. Please try again.",variant:"destructive"})}finally{O(!1)}});h.useEffect(()=>{u.trim()||(T([]),B(!1))},[u]);const F=i==null?void 0:i.getDeliveredOrdersByWeek;let N={};try{v||(N=F?F(31):{})}catch(s){console.error("Error getting delivered orders by week:",s),N={}}const he=s=>{let t=0,n=0;return s.forEach(r=>{const m=(r==null?void 0:r.tons)||0;((r==null?void 0:r.order_type)||"straight-bar")==="cut-and-bend"?n+=m:t+=m}),{straightBar:Math.round(t*100)/100,cutAndBend:Math.round(n*100)/100,total:Math.round((t+n)*100)/100}},ge=s=>{const t={};return s.forEach(n=>{const r=n.date;t[r]||(t[r]=[]),t[r].push(n)}),t},fe=s=>{let t=0,n=0;return s.forEach(r=>{const m=(r==null?void 0:r.tons)||0;((r==null?void 0:r.order_type)||"straight-bar")==="cut-and-bend"?n+=m:t+=m}),{straightBar:Math.round(t*100)/100,cutAndBend:Math.round(n*100)/100,total:Math.round((t+n)*100)/100}},p=Object.keys(N).sort((s,t)=>{const n=new Date(s.split("_")[0]);return new Date(t.split("_")[0]).getTime()-n.getTime()});h.useEffect(()=>{p.length>0&&!W&&U(p[0])},[p.join(","),W]);const je=s=>{try{const[t,n]=s.split("_"),r=new Date(t),m=new Date(n),x={month:"short",day:"numeric"};return`${r.toLocaleDateString("en-US",x)} - ${m.toLocaleDateString("en-US",re(te({},x),{year:"numeric"}))}`}catch(t){return"Invalid Week Range"}},P=s=>{if(!s)return"Invalid Date";try{const t=new Date(s);return isNaN(t.getTime())?"Invalid Date":t.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}catch(t){return"Invalid Date"}},V=s=>e.jsx(g,{className:"bg-success text-success-foreground",children:"Delivered"}),Q=s=>{console.log("ðŸ” History - Selected order:",s),S(s),y(!0)},q=()=>v?k.length:f?p.reduce((s,t)=>{var r;const n=((r=N[t])==null?void 0:r.filter(m=>!m.signed_delivery_note))||[];return s+n.length},0):p.reduce((s,t)=>{var n;return s+(((n=N[t])==null?void 0:n.length)||0)},0),K=s=>f?s.filter(t=>!t.signed_delivery_note):s;return e.jsx("div",{className:"space-y-6",children:xe?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading delivery history..."})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>M("/"),className:"text-foreground hover:bg-accent",children:[e.jsx(He,{size:16}),"Back to Dashboard"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-headline font-bold text-foreground",children:"Delivery Archive"}),e.jsx("p",{className:"text-muted-foreground",children:"Complete historical record of all delivered orders with daily metrics"})]})]}),e.jsx(w,{children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(L,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground",size:16}),e.jsx(Oe,{id:"history-search",name:"historySearch",placeholder:"Search across entire database (delivery number, name, company...)",value:u,onChange:s=>C(s.target.value),onKeyDown:s=>{s.key==="Enter"&&$()},className:"pl-10 bg-background text-foreground border-border"})]}),e.jsxs(b,{onClick:$,variant:"default",size:"sm",disabled:!u.trim(),className:"text-primary-foreground",children:[e.jsx(L,{className:"h-4 w-4 mr-1"}),"Search"]}),e.jsxs(b,{onClick:ue,variant:"outline",size:"sm",className:"text-foreground border-border hover:bg-accent",children:[e.jsx(ke,{className:"h-4 w-4 mr-1"}),v||f?"Clear Filter":"Refresh"]}),e.jsxs(b,{onClick:()=>I(!f),variant:f?"default":"outline",size:"sm",className:f?"text-primary-foreground":"text-foreground border-border hover:bg-accent",disabled:v,children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),f?"Showing Unsigned":"Show Unsigned Only"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:v?`${k.length} results found`:f?`${q()} unsigned orders`:`${q()} orders (past 31 days)`})]})})}),e.jsx("div",{className:"space-y-4",children:v?k.length>0?e.jsx(w,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground mb-4",children:['Search Results for "',u,'"']}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ie,{children:[e.jsx(le,{children:e.jsxs(E,{className:"border-border",children:[e.jsx(c,{className:"text-foreground",children:"Delivery Number"}),e.jsx(c,{className:"text-foreground",children:"Delivery Name"}),e.jsx(c,{className:"text-foreground",children:"Company"}),e.jsx(c,{className:"text-foreground",children:"Site"}),e.jsx(c,{className:"text-foreground",children:"Date"}),e.jsx(c,{className:"text-foreground",children:"Status"}),e.jsx(c,{className:"text-foreground",children:"Tons"}),e.jsx(c,{className:"text-foreground",children:"Shift"}),e.jsx(c,{className:"text-foreground",children:"Delivery Note"}),e.jsx(c,{className:"text-foreground",children:"Contact"}),e.jsx(c,{className:"text-foreground",children:"Actions"})]})}),e.jsx(oe,{children:k.map(s=>{var t,n;return e.jsxs(E,{className:"border-border hover:bg-muted/50",children:[e.jsx(d,{className:"font-mono text-foreground",children:s.delivery_number||s.id}),e.jsx(d,{className:"text-foreground",children:s.customer_name}),e.jsx(d,{className:"text-foreground",children:s.company||"N/A"}),e.jsx(d,{className:"text-foreground",children:s.site||"N/A"}),e.jsx(d,{className:"text-foreground",children:P(s.date)}),e.jsx(d,{children:V(s.status)}),e.jsxs(d,{className:"text-foreground",children:[s.tons," tons"]}),e.jsx(d,{children:e.jsx(g,{className:s.shift==="morning"?"bg-blue-100 text-blue-800":"bg-purple-100 text-purple-800",children:s.shift==="morning"?"Morning":"Night"})}),e.jsx(d,{children:e.jsx(de,{action:"edit",fallback:s.signed_delivery_note?e.jsxs(g,{className:"bg-success text-success-foreground",children:[e.jsx(H,{size:12,className:"mr-1"}),"Signed"]}):e.jsxs(g,{className:"bg-gray-400 text-white",children:[e.jsx(_,{size:12,className:"mr-1"}),"Not Signed"]}),children:e.jsx("div",{onClick:r=>D(null,null,function*(){r.preventDefault(),r.stopPropagation();try{const m=!s.signed_delivery_note,x={signed_delivery_note:m};yield ne.update(s.id,x),yield $(),o({title:"Delivery Note Updated",description:`Delivery note marked as ${m?"signed":"not signed"}.`})}catch(m){console.error("âŒ Failed to update delivery note:",m),o({title:"Error",description:"Failed to update delivery note. Please try again.",variant:"destructive"})}}),className:"cursor-pointer",title:`Click to mark as ${s.signed_delivery_note?"not signed":"signed"}`,children:s.signed_delivery_note?e.jsxs(g,{className:"bg-success text-success-foreground cursor-pointer hover:bg-success/80 transition-colors",children:[e.jsx(H,{size:12,className:"mr-1"}),"Signed"]}):e.jsxs(g,{className:"bg-gray-400 text-white cursor-pointer hover:bg-gray-500 transition-colors",children:[e.jsx(_,{size:12,className:"mr-1"}),"Not Signed"]})})})}),e.jsx(d,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-foreground",children:s.driver_name||"N/A"}),s.phone_number?e.jsxs("a",{href:`tel:${s.phone_number.replace(/[\s\-\(\)]/g,"")}`,className:"text-sm text-primary hover:text-primary/80 underline cursor-pointer",title:"Click to call",children:["ðŸ“ž ",s.phone_number]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"-"})]})}),e.jsx(d,{children:e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>Q(s),className:"bg-transparent text-foreground hover:bg-accent hover:text-accent-foreground",title:A((t=a==null?void 0:a.profile)==null?void 0:t.role,"edit")?"Edit Order Details":"View Order Details",children:A((n=a==null?void 0:a.profile)==null?void 0:n.role,"edit")?e.jsx(me,{size:16}):e.jsx(ce,{size:16})})})]},s.id)})})]})})]})}):e.jsx(w,{children:e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(L,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No results found"}),e.jsxs("p",{className:"text-muted-foreground",children:['No orders found matching "',u,'". Try different search terms.']})]})}):p.length>0?e.jsxs(Te,{value:W,onValueChange:U,className:"space-y-4",children:[e.jsx(Be,{className:"w-full justify-start overflow-x-auto flex-wrap h-auto",children:p.map(s=>{const t=K(N[s]),n=he(t);return f&&t.length===0?null:e.jsxs(ze,{value:s,className:"flex-col items-start px-4 py-2 h-auto",children:[e.jsx("span",{className:"font-semibold",children:je(s)}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[t.length," orders â€¢ ",n.total," tons"]})]},s)})}),p.map(s=>{const t=K(N[s]);if(f&&t.length===0)return null;const n=ge(t),r=Object.keys(n).sort((m,x)=>new Date(x).getTime()-new Date(m).getTime());return e.jsx(Ae,{value:s,className:"space-y-4",children:r.map(m=>{const x=n[m],X=fe(x);return e.jsx(w,{children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold text-foreground",children:P(m)}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2.5 h-2.5 bg-green-500 rounded-full"}),e.jsxs("span",{className:"text-sm text-foreground",children:["Straight Bar: ",e.jsxs("strong",{children:[X.straightBar," tons"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2.5 h-2.5 bg-purple-500 rounded-full"}),e.jsxs("span",{className:"text-sm text-foreground",children:["Cut & Bend: ",e.jsxs("strong",{children:[X.cutAndBend," tons"]})]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[x.length," orders"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ie,{children:[e.jsx(le,{children:e.jsxs(E,{className:"border-border",children:[e.jsx(c,{className:"text-foreground",children:"Delivery Number"}),e.jsx(c,{className:"text-foreground",children:"Delivery Name"}),e.jsx(c,{className:"text-foreground",children:"Company"}),e.jsx(c,{className:"text-foreground",children:"Site"}),e.jsx(c,{className:"text-foreground",children:"Status"}),e.jsx(c,{className:"text-foreground",children:"Tons"}),e.jsx(c,{className:"text-foreground",children:"Shift"}),e.jsx(c,{className:"text-foreground",children:"Delivery Note"}),e.jsx(c,{className:"text-foreground",children:"Contact"}),e.jsx(c,{className:"text-foreground",children:"Actions"})]})}),e.jsx(oe,{children:x.map(l=>{var G,J;return e.jsxs(E,{className:"border-border hover:bg-muted/50",children:[e.jsx(d,{className:"font-mono text-foreground",children:l.delivery_number||l.id}),e.jsx(d,{className:"text-foreground",children:l.customer_name}),e.jsx(d,{className:"text-foreground",children:l.company||"N/A"}),e.jsx(d,{className:"text-foreground",children:l.site||"N/A"}),e.jsx(d,{children:V(l.status)}),e.jsxs(d,{className:"text-foreground",children:[l.tons," tons"]}),e.jsx(d,{children:e.jsx(g,{className:l.shift==="morning"?"bg-blue-100 text-blue-800":"bg-purple-100 text-purple-800",children:l.shift==="morning"?"Morning":"Night"})}),e.jsx(d,{children:e.jsx(de,{action:"edit",fallback:l.signed_delivery_note?e.jsxs(g,{className:"bg-success text-success-foreground",children:[e.jsx(H,{size:12,className:"mr-1"}),"Signed"]}):e.jsxs(g,{className:"bg-gray-400 text-white",children:[e.jsx(_,{size:12,className:"mr-1"}),"Not Signed"]}),children:e.jsx("div",{onClick:Y=>D(null,null,function*(){Y.preventDefault(),Y.stopPropagation();try{console.log("ðŸ”„ Toggling delivery note for history order:",l.id),console.log("ðŸ“‹ Current status:",l.signed_delivery_note);const z=!l.signed_delivery_note,pe={signed_delivery_note:z};yield ne.update(l.id,pe);const Z=ae.getState();Z.loadHistoryOrders&&(yield Z.loadHistoryOrders()),o({title:"Delivery Note Updated",description:`Delivery note marked as ${z?"signed":"not signed"}.`})}catch(z){console.error("âŒ Failed to update delivery note:",z),o({title:"Error",description:"Failed to update delivery note. Please try again.",variant:"destructive"})}}),className:"cursor-pointer",title:`Click to mark as ${l.signed_delivery_note?"not signed":"signed"}`,children:l.signed_delivery_note?e.jsxs(g,{className:"bg-success text-success-foreground cursor-pointer hover:bg-success/80 transition-colors",children:[e.jsx(H,{size:12,className:"mr-1"}),"Signed"]}):e.jsxs(g,{className:"bg-gray-400 text-white cursor-pointer hover:bg-gray-500 transition-colors",children:[e.jsx(_,{size:12,className:"mr-1"}),"Not Signed"]})})})}),e.jsx(d,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-foreground",children:l.driver_name||"N/A"}),l.phone_number?e.jsxs("a",{href:`tel:${l.phone_number.replace(/[\s\-\(\)]/g,"")}`,className:"text-sm text-primary hover:text-primary/80 underline cursor-pointer",title:"Click to call",children:["ðŸ“ž ",l.phone_number]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"-"})]})}),e.jsx(d,{children:e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>Q(l),className:"bg-transparent text-foreground hover:bg-accent hover:text-accent-foreground",title:A((G=a==null?void 0:a.profile)==null?void 0:G.role,"edit")?"Edit Order Details":"View Order Details",children:A((J=a==null?void 0:a.profile)==null?void 0:J.role,"edit")?e.jsx(me,{size:16}):e.jsx(ce,{size:16})})})]},l.id)})})]})})]})},m)})},s)})]}):e.jsx(w,{children:e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(Me,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No delivered orders found"}),e.jsx("p",{className:"text-muted-foreground",children:"No delivered orders in the past 31 days."})]})})}),e.jsx(Ee,{order:R,open:j,onOpenChange:y})]})})}export{es as History};
